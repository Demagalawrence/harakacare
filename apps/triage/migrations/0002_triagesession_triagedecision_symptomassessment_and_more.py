# Generated by Django 6.0.2 on 2026-02-05 14:12

import django.core.validators
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('triage', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='TriageSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('status', models.CharField(choices=[('draft', 'Draft'), ('pending', 'Pending'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('cancelled', 'Cancelled'), ('failed', 'Failed'), ('archived', 'Archived')], default='draft', max_length=20)),
                ('status_changed_at', models.DateTimeField(auto_now=True)),
                ('status_reason', models.TextField(blank=True, null=True)),
                ('patient_token', models.CharField(db_index=True, help_text='Anonymous identifier for this patient session', max_length=64, unique=True, verbose_name='patient token')),
                ('session_status', models.CharField(choices=[('started', 'Started'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('escalated', 'Escalated'), ('cancelled', 'Cancelled')], default='started', max_length=20, verbose_name='session status')),
                ('age_range', models.CharField(choices=[('under_5', 'Under 5'), ('5_12', '5-12'), ('13_17', '13-17'), ('18_30', '18-30'), ('31_50', '31-50'), ('51_plus', '51+')], help_text='Patient age range', max_length=20, verbose_name='age range')),
                ('sex', models.CharField(blank=True, choices=[('male', 'Male'), ('female', 'Female'), ('prefer_not_to_say', 'Prefer not to say')], max_length=20, null=True, verbose_name='sex')),
                ('district', models.CharField(help_text='District or area', max_length=100, verbose_name='district')),
                ('subcounty', models.CharField(blank=True, help_text='Sub-county or division', max_length=100, null=True, verbose_name='subcounty')),
                ('device_location_lat', models.FloatField(blank=True, help_text='Device GPS latitude (consent-based)', null=True, verbose_name='latitude')),
                ('device_location_lng', models.FloatField(blank=True, help_text='Device GPS longitude (consent-based)', null=True, verbose_name='longitude')),
                ('location_consent', models.BooleanField(default=False, help_text='Whether patient consented to share device location', verbose_name='location consent')),
                ('primary_symptom', models.CharField(choices=[('fever', 'Fever'), ('headache', 'Headache'), ('chest_pain', 'Chest pain'), ('difficulty_breathing', 'Difficulty breathing'), ('abdominal_pain', 'Abdominal pain'), ('vomiting', 'Vomiting'), ('diarrhea', 'Diarrhea'), ('injury_trauma', 'Injury / trauma'), ('skin_problem', 'Skin problem'), ('other', 'Other')], max_length=50, verbose_name='primary symptom')),
                ('secondary_symptoms', models.JSONField(blank=True, default=list, help_text='Secondary symptoms (multiple choice)', verbose_name=models.CharField(max_length=50))),
                ('symptom_severity', models.CharField(choices=[('mild', 'Mild'), ('moderate', 'Moderate'), ('severe', 'Severe'), ('very_severe', 'Very severe')], max_length=20, verbose_name='symptom severity')),
                ('symptom_duration', models.CharField(choices=[('today', 'Today'), ('1_3_days', '1-3 days'), ('4_7_days', '4-7 days'), ('more_than_1_week', 'More than 1 week'), ('more_than_1_month', 'More than 1 month')], max_length=20, verbose_name='symptom duration')),
                ('symptom_pattern', models.CharField(blank=True, choices=[('getting_better', 'Getting better'), ('staying_same', 'Staying the same'), ('getting_worse', 'Getting worse'), ('comes_and_goes', 'Comes and goes')], max_length=20, null=True, verbose_name='symptom pattern')),
                ('red_flags', models.JSONField(blank=True, default=list, help_text='Emergency red-flag symptoms detected', verbose_name=models.CharField(max_length=50))),
                ('has_red_flags', models.BooleanField(default=False, help_text='Whether any emergency red flags were detected', verbose_name='has red flags')),
                ('condition_occurrence', models.CharField(choices=[('first_occurrence', 'First occurrence'), ('happened_before', 'Happened before'), ('long_term', 'Long-term / continuous condition')], max_length=30, verbose_name='condition occurrence')),
                ('chronic_conditions', models.JSONField(blank=True, default=list, help_text='Pre-existing chronic conditions', verbose_name=models.CharField(max_length=50))),
                ('current_medication', models.CharField(blank=True, choices=[('yes', 'Yes'), ('no', 'No'), ('not_sure', 'Not sure')], max_length=20, null=True, verbose_name='current medication')),
                ('has_allergies', models.CharField(blank=True, choices=[('yes', 'Yes'), ('no', 'No'), ('not_sure', 'Not sure')], max_length=20, null=True, verbose_name='has allergies')),
                ('allergy_types', models.JSONField(blank=True, default=list, help_text='Types of allergies: medication, food, environmental', verbose_name=models.CharField(max_length=30))),
                ('pregnancy_status', models.CharField(blank=True, choices=[('yes', 'Yes'), ('no', 'No'), ('not_applicable', 'Not applicable'), ('prefer_not_to_say', 'Prefer not to say')], max_length=30, null=True, verbose_name='pregnancy status')),
                ('additional_description', models.TextField(blank=True, help_text='Short free-text description (character-limited)', max_length=500, verbose_name='additional description')),
                ('consent_medical_triage', models.BooleanField(default=False, verbose_name='consent for medical triage')),
                ('consent_data_sharing', models.BooleanField(default=False, help_text='Consent for anonymized data sharing with health facilities', verbose_name='consent for data sharing')),
                ('consent_follow_up', models.BooleanField(default=False, help_text='Consent for follow-up if required', verbose_name='consent for follow-up')),
                ('risk_level', models.CharField(blank=True, choices=[('low', 'Low Risk'), ('medium', 'Medium Risk'), ('high', 'High Risk')], help_text='AI-assessed risk level', max_length=20, null=True, verbose_name='risk level')),
                ('risk_confidence', models.FloatField(blank=True, help_text='AI model confidence score (0-1)', null=True, validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(1.0)], verbose_name='risk confidence')),
                ('follow_up_priority', models.CharField(blank=True, choices=[('routine', 'Routine'), ('urgent', 'Urgent'), ('immediate', 'Immediate')], max_length=20, null=True, verbose_name='follow-up priority')),
                ('ai_model_version', models.CharField(blank=True, help_text='Version of AI model used for assessment', max_length=50, null=True, verbose_name='AI model version')),
                ('assessment_completed_at', models.DateTimeField(blank=True, null=True, verbose_name='assessment completed at')),
                ('forwarded_to_followup', models.BooleanField(default=False, verbose_name='forwarded to follow-up agent')),
                ('forwarded_to_facility', models.BooleanField(default=False, verbose_name='forwarded to facility matching')),
                ('channel', models.CharField(choices=[('ussd', 'USSD'), ('sms', 'SMS'), ('whatsapp', 'WhatsApp'), ('web', 'Web'), ('mobile_app', 'Mobile App')], default='ussd', max_length=20, verbose_name='channel')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'triage session',
                'verbose_name_plural': 'triage sessions',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TriageDecision',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('final_risk_level', models.CharField(choices=[('low', 'Low Risk'), ('medium', 'Medium Risk'), ('high', 'High Risk')], help_text='Final triage risk level', max_length=20, verbose_name='final risk level')),
                ('follow_up_priority', models.CharField(choices=[('routine', 'Routine'), ('urgent', 'Urgent'), ('immediate', 'Immediate')], help_text='Priority for follow-up', max_length=20, verbose_name='follow-up priority')),
                ('decision_basis', models.CharField(choices=[('ai_primary', 'AI Primary'), ('red_flag_override', 'Red Flag Override'), ('clinical_adjustment', 'Clinical Adjustment'), ('conservative_bias', 'Conservative Bias')], help_text='Primary basis for final decision', max_length=50, verbose_name='decision basis')),
                ('recommended_action', models.TextField(help_text='Recommended next steps for patient', verbose_name='recommended action')),
                ('facility_type_recommendation', models.CharField(blank=True, choices=[('emergency', 'Emergency Department'), ('hospital', 'Hospital'), ('health_center', 'Health Center'), ('clinic', 'Clinic'), ('self_care', 'Self-care with monitoring')], max_length=50, null=True, verbose_name='facility type recommendation')),
                ('decision_timestamp', models.DateTimeField(auto_now_add=True, verbose_name='decision timestamp')),
                ('decision_reasoning', models.TextField(help_text='Detailed explanation of how decision was reached', verbose_name='decision reasoning')),
                ('disclaimers', models.JSONField(default=list, help_text='Disclaimers shown to patient', verbose_name=models.TextField())),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='triage_decision', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'triage decision',
                'verbose_name_plural': 'triage decisions',
            },
        ),
        migrations.CreateModel(
            name='SymptomAssessment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('symptom_complexity_score', models.FloatField(help_text='Calculated complexity score based on symptoms', validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(10.0)], verbose_name='symptom complexity score')),
                ('symptom_cluster', models.CharField(blank=True, help_text='Identified symptom cluster (e.g., respiratory, gastrointestinal)', max_length=100, verbose_name='symptom cluster')),
                ('differential_conditions', models.JSONField(blank=True, default=list, help_text='Possible conditions based on symptoms (for reference only)', verbose_name=models.CharField(max_length=100))),
                ('assessment_notes', models.TextField(blank=True, help_text='AI-generated clinical assessment notes', verbose_name='assessment notes')),
                ('pain_scale', models.IntegerField(blank=True, help_text='Pain intensity 0-10', null=True, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(10)], verbose_name='pain scale')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='symptom_assessment', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'symptom assessment',
                'verbose_name_plural': 'symptom assessments',
            },
        ),
        migrations.CreateModel(
            name='RiskClassification',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('raw_risk_score', models.FloatField(help_text='Raw AI model risk score (0-1)', validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(1.0)], verbose_name='raw risk score')),
                ('ai_risk_level', models.CharField(choices=[('low', 'Low Risk'), ('medium', 'Medium Risk'), ('high', 'High Risk')], help_text='AI-determined risk level before adjustments', max_length=20, verbose_name='AI risk level')),
                ('confidence_score', models.FloatField(help_text='Model confidence in prediction', validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(1.0)], verbose_name='confidence score')),
                ('model_name', models.CharField(help_text='Name of AI model used', max_length=100, verbose_name='model name')),
                ('model_version', models.CharField(help_text='Version of model used', max_length=50, verbose_name='model version')),
                ('inference_time_ms', models.IntegerField(blank=True, help_text='Time taken for inference in milliseconds', null=True, verbose_name='inference time (ms)')),
                ('feature_importance', models.JSONField(blank=True, help_text='Which features contributed most to classification', null=True, verbose_name='feature importance')),
                ('symptom_embedding', models.JSONField(blank=True, help_text='Symptom text embeddings (for analysis)', null=True, verbose_name='symptom embedding')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='risk_classification', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'risk classification',
                'verbose_name_plural': 'risk classifications',
            },
        ),
        migrations.CreateModel(
            name='RedFlagDetection',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('difficulty_breathing', models.BooleanField(default=False, verbose_name='difficulty breathing')),
                ('chest_pain', models.BooleanField(default=False, verbose_name='chest pain')),
                ('loss_of_consciousness', models.BooleanField(default=False, verbose_name='loss of consciousness')),
                ('convulsions', models.BooleanField(default=False, verbose_name='convulsions/seizures')),
                ('severe_bleeding', models.BooleanField(default=False, verbose_name='severe bleeding')),
                ('confusion', models.BooleanField(default=False, verbose_name='confusion or inability to talk')),
                ('high_fever_unresponsive', models.BooleanField(default=False, verbose_name='high fever not responding')),
                ('emergency_override', models.BooleanField(default=False, help_text='Whether red flags override AI assessment', verbose_name='emergency override')),
                ('detection_method', models.CharField(choices=[('user_input', 'User Input'), ('ai_detected', 'AI Detected'), ('rule_based', 'Rule-based')], default='user_input', max_length=50, verbose_name='detection method')),
                ('detected_flags_count', models.IntegerField(default=0, help_text='Number of red flags detected', verbose_name='detected flags count')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='red_flag_detection', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'red flag detection',
                'verbose_name_plural': 'red flag detections',
            },
        ),
        migrations.CreateModel(
            name='ClinicalContext',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('chronic_condition_modifier', models.FloatField(default=0.0, help_text='Risk adjustment for chronic conditions (-1.0 to +1.0)', verbose_name='chronic condition modifier')),
                ('pregnancy_modifier', models.FloatField(default=0.0, help_text='Risk adjustment for pregnancy', verbose_name='pregnancy modifier')),
                ('age_modifier', models.FloatField(default=0.0, help_text='Risk adjustment for age (young/elderly)', verbose_name='age modifier')),
                ('medication_allergy_modifier', models.FloatField(default=0.0, help_text='Risk adjustment for medication and allergies', verbose_name='medication/allergy modifier')),
                ('total_risk_adjustment', models.FloatField(default=0.0, help_text='Combined risk adjustment factor', verbose_name='total risk adjustment')),
                ('adjustment_reasoning', models.TextField(blank=True, help_text='Explanation for risk adjustments made', verbose_name='adjustment reasoning')),
                ('adjusted_risk_level', models.CharField(choices=[('low', 'Low Risk'), ('medium', 'Medium Risk'), ('high', 'High Risk')], help_text='Risk level after clinical context adjustments', max_length=20, verbose_name='adjusted risk level')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='clinical_context', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'clinical context',
                'verbose_name_plural': 'clinical contexts',
            },
        ),
        migrations.CreateModel(
            name='AgentCommunicationLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('target_agent', models.CharField(choices=[('follow_up', 'Follow-up Agent'), ('facility_matching', 'Facility Matching Agent'), ('notification', 'Notification Agent')], max_length=50, verbose_name='target agent')),
                ('payload', models.JSONField(help_text='JSON payload sent to target agent', verbose_name='payload')),
                ('communication_status', models.CharField(choices=[('pending', 'Pending'), ('sent', 'Sent'), ('acknowledged', 'Acknowledged'), ('failed', 'Failed')], default='pending', max_length=20, verbose_name='status')),
                ('response_data', models.JSONField(blank=True, help_text='Response received from target agent', null=True, verbose_name='response data')),
                ('sent_at', models.DateTimeField(blank=True, null=True, verbose_name='sent at')),
                ('acknowledged_at', models.DateTimeField(blank=True, null=True, verbose_name='acknowledged at')),
                ('error_message', models.TextField(blank=True, help_text='Error message if communication failed', verbose_name='error message')),
                ('retry_count', models.IntegerField(default=0, help_text='Number of retry attempts', verbose_name='retry count')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('triage_session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='agent_communications', to='triage.triagesession', verbose_name='triage session')),
            ],
            options={
                'verbose_name': 'agent communication log',
                'verbose_name_plural': 'agent communication logs',
                'ordering': ['-created_at'],
            },
        ),
        migrations.DeleteModel(
            name='Triage',
        ),
        migrations.AddIndex(
            model_name='triagesession',
            index=models.Index(fields=['patient_token'], name='triage_tria_patient_b82edb_idx'),
        ),
        migrations.AddIndex(
            model_name='triagesession',
            index=models.Index(fields=['risk_level', 'created_at'], name='triage_tria_risk_le_f39dbf_idx'),
        ),
        migrations.AddIndex(
            model_name='triagesession',
            index=models.Index(fields=['district', 'subcounty'], name='triage_tria_distric_289588_idx'),
        ),
        migrations.AddIndex(
            model_name='triagesession',
            index=models.Index(fields=['has_red_flags'], name='triage_tria_has_red_456dc0_idx'),
        ),
        migrations.AddIndex(
            model_name='triagesession',
            index=models.Index(fields=['session_status'], name='triage_tria_session_1b2fda_idx'),
        ),
        migrations.AddIndex(
            model_name='agentcommunicationlog',
            index=models.Index(fields=['triage_session', 'target_agent'], name='triage_agen_triage__e0d146_idx'),
        ),
        migrations.AddIndex(
            model_name='agentcommunicationlog',
            index=models.Index(fields=['communication_status'], name='triage_agen_communi_76dfd7_idx'),
        ),
    ]
